---
title: "p8105_hw3_zc2822"
author: "Zhengyong Chen"
output: github_document
---

```{r setup, echo=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
```

## Problem 2

**Load, tidy, merge, and organize the data sets.**

```{r, message=FALSE}
demo_df = 
  read_csv("data/nhanes_covar.csv", na = c("NA", ".", ""), skip = 4) |> 
  janitor::clean_names() |> 
  filter(age >= 21, 
         !is.na(sex), !is.na(age), !is.na(bmi), !is.na(education)) |> 
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female"), ordered = TRUE),
    education = factor(education, levels = c(1, 2, 3), 
                       labels = c("Less than HS", "HS equivalent", "More than HS"), 
                       ordered = TRUE)
  )

accel_df = 
  read_csv("data/nhanes_accel.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names()

mims_df <- left_join(demo_df, accel_df, by = "seqn")
```

**Table for the number of men and women in each education category.**

```{r, message=FALSE}
demo_df |> 
  group_by(education, sex) |> 
  summarise(count = n()) |> 
  pivot_wider(
    names_from = sex,
    values_from = count
  ) |> 
  knitr::kable()
```

**Visualization of the age distributions for men and women in each education category. **

```{r}
demo_df |> 
  group_by(education, sex) |> 
  ggplot(aes(x = education, y = age, fill = sex)) +
  geom_boxplot(alpha = .5) +
  scale_fill_manual(values = c("Male" = "blue", "Female" = "red")) +
  labs(title = "Age distributions for men and women in each education category")
```

**Comment:**

The younger age group (<40) of female tends to have a more than high school education, and that of male tends to have a high school equivalent and more than high school education.

For the less than high school education category, the age spread of male and female does not differ much, with medians around 60, which is a little bit larger in female group, but the largest age in male group is larger than that in female group.

For the high school equivalent education category, from both the age spread and the median, male tends to be younger than female.

For the more than high school education category, the age spread of male and female does not differ much, but the female group has a smaller median.



**Plot total activities against age. **

```{r, message = FALSE}
mims_df |> 
  rowwise() |> 
  mutate(total_activity = sum(c_across(starts_with("min")), na.rm = TRUE)) |> 
  ungroup() |> 
  ggplot(aes(x = age, y = total_activity, col = sex)) +
  geom_point(alpha = .5) +
  scale_color_manual(values = c("Male" = "blue", "Female" = "red")) +
  facet_wrap(~ education) + 
  geom_smooth(se = FALSE) + 
  labs(title = "Total activity vs age by education level and sex",
       x = "Age", 
       y = "Total Activity")
```

**Comment:**

Total activity tends to decrease with age in all education groups, but the patterns are different. Female generally have higher total activity compared to male in more than or equivalent to high school education groups.

For the less than high school group, female shows an overall decreasing trend of total activity as age increases, while male first decreases in total activity, then rises to a peak at around age 60, and then decreases sharply.

For the high school equivalent group, female has two peaks of total activity, one at age 40, and the other at age 70. Male's total activity increases before age 40, and then decreases.

For the more than high school group, both sexes show an flat trend of total activity until around age 50, then decrease sharply.


**24-hour activity time courses**

```{r, message = FALSE}
mims_df_long = mims_df |> 
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               names_prefix = "min", 
               values_to = "activity") |> 
  mutate(minute = as.numeric(minute))  

ggplot(mims_df_long, aes(x = minute, y = activity, color = sex)) +
  geom_point(alpha = .05, size = .1) + 
  facet_wrap(~ education) +  
  scale_color_manual(values = c("Male" = "blue", "Female" = "red")) +  
  geom_smooth(se = FALSE) +
  labs(title = "24 hour activity time courses by education and sex",
       x = "Minute",
       y = "Activity") 
```

In all three education groups, activity starts low, increases in the middle of the day, and decreases toward the end of the day. The less than high school education group has the most obvious peak during the day. Male and female pattern within each education group are similar.

## Problem 3

**Import, clean, and tidy these data, and describe the resulting dataset.**

```{r, message = FALSE}
jan20_df = read_csv("data/citibike/Jan 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    year = "2020",
    month = "Jan"
  )

jan24_df = read_csv("data/citibike/Jan 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    year = "2024",
    month = "Jan"
  )

july20_df = read_csv("data/citibike/July 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    year = "2020",
    month = "July"
  )

july24_df = read_csv("data/citibike/July 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    year = "2024",
    month = "July"
  )

bike_df = bind_rows(jan20_df, jan24_df, july20_df, july24_df) |> 
  relocate(year, month, .before = weekdays) |> 
  mutate(weekdays = factor(weekdays, levels= c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")))
```

The resulting dataset `bike_df` combines the datesets in four months. It has `r ncol(bike_df)` variables: `r colnames(bike_df)`, and it has `r nrow(bike_df)` rows.

**Table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members.**

```{r}
bike_df |> 
  group_by(year, month, member_casual) |> 
  summarise(count = n()) |> 
  pivot_wider(
    names_from = "member_casual",
    values_from = "count"
  ) |> 
  knitr::kable()
```

In both 2020 and 2024, the number of all rides is lower in January compared to July. This might due to January is too cold to bike. From 2020 to 2024, the number of rides for both casual riders members has increased significantly. This means the citi bike system becomes more popular and has expanded. 

**Table showing the 5 most popular starting stations for July 2024.**

```{r}
july24_df |> 
  group_by(start_station_name) |> 
  summarise(num_rides = n()) |> 
  arrange(desc(num_rides)) |> 
  slice(1:5) |> 
  knitr::kable()
```

**Plot showing the effects of day of the week, month, and year on median ride duration.**

```{r}
bike_df |> 
  group_by(year, month, weekdays) |> 
  summarise(median_duration = median(duration, na.rm = TRUE)) |> 
  ggplot(aes(x = weekdays, y = median_duration, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ year) +
  labs(title = "Median ride duration by day of the week, month, and year",
       x = "Weekdays",
       y = "Median duration") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
```

In both 2020 and 2024, the median duration is higher in July compared to January, this might because warmer weather encourages longer rides. And in both years, the median duration tends to be higher on weekends compared to weekdays, this might because people have more time to ride on weekends. 

The median duration in 2020 are generally higher than those in 2024. And the difference of median durarion between Jan and July are larger in 2020 than that in 2024.


**For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration. Comment on your results.**

```{r}
bike_df |> 
  filter(year == 2024) |> 
  ggplot(aes(x = month, y = duration, fill = member_casual)) +
  geom_boxplot() +
  facet_wrap(~ rideable_type) +
  labs(title = "Impact of month, membership status, and bike type on ride duration",
       x = "Month",
       y = "Ride duration")
```

Casual riders tend to have longer ride durations than members. Casual riders also show more variability in ride duration. Electric bike rides tend to have a longer upper range of ride durations, and there are more outliers. Members have less difference in duration during difference months, so their riding habit might be less influenced by season.





